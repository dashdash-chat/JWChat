<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title>JWChat - Groupchat</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <script src="shared.js" language="JavaScript1.2"></script>
    <script src="browsercheck.js" language="JavaScript1.2"></script>
    <script src="emoticons.js" language="JavaScript1.2"></script>
    <script src="config.js" language="JavaScript1.2"></script>
    <script src="statusLed.js" language="JavaScript1.2"></script>
    <script src="roster.js" language="JavaScript1.2"></script>   
    <script language="JavaScript1.2">
var colors = new Array('maroon','green','olive','navy','purple','teal','red','blue');

function putMsgHTML(msg,mtime,user,usercolor) {
  var msgHTML = '';
  
  msg = msgFormat(msg);

  msgHTML += "<span class=time>["+mtime+"] </span>";    
  
  if (msg.match(/^\/me /)) {
    msg = msg.replace(/^\/me /,"<font color=\"green\" title='@ "+mtime+"'><b>* "+user+"</b></font> ");
  } else if (user != group) {
    msgHTML += "<font color=\""+usercolor+"\" title='@ "+mtime+"'>&lt;" + user + "&gt;</font>";
  }

  if (user == group) /* channel status messages */
    msgHTML += "<b>"+msg+"</b><br>";
  else
    msgHTML += " " + msg + "<br>";
  
  cFrame.body.innerHTML += msgHTML;
  frames.groupchatChat.groupchatIChat.scrollTo(0,cFrame.body.scrollHeight);
}

function popMsgs() {

  if (!user) 
    user = srcW.roster.getUserByJID(group);

  while (user.chatmsgs.length>0) {
    var msg;
    if (is.ie5||is.op) {
      msg = user.chatmsgs[0];
      user.chatmsgs = user.chatmsgs.slice(1,user.chatmsgs.length);
    } else
      msg = user.chatmsgs.shift();

    if (msg.from.indexOf('/') != -1)
      msg.from = msg.from.substring(msg.from.indexOf('/')+1);

		/* get date */
		var timestamp;
		if (msg.timestamp)
			timestamp = msg.timestamp;
		else
			timestamp = new Date();

		if (typeof(msg.o) != 'undefined' && msg.o.length > 0) { // chan-history
			for (var i in msg.o)
				if (msg.o[i].tagname == 'x' && typeof(msg.o[i].stamp) != 'undefined' && msg.o[i].xmlns == 'jabber:x:delay') { // found timestamp
					var stamp = msg.o[i].stamp;
					timestamp = new Date(Date.UTC(stamp.substring(0,4),stamp.substring(4,6)-1,stamp.substring(6,8),stamp.substring(9,11),stamp.substring(12,14),stamp.substring(15,17)));
					break; // done
				}
		}

		var mtime = '';
		if (new Date() - timestamp > 24*3600*1000)
			mtime += timestamp.toLocaleDateString() + " ";
		
		mtime += timestamp.toLocaleTimeString();
    
    /* look for a subject */
    if (msg.subject) { // set topic
      user.roster.subject = msg.subject;
      frames.groupchatTop.document.forms[0].elements['subject'].value = msg.subject;
//      putMsgHTML(loc("/me has set the topic to: [_1]", msg.subject), mtime, msg.from);
			return;
    }

    if(!msg.body || msg.body == '') {
			if (msg.o && msg.o[0].tagname == 'body')
				msg.body = msg.o[0].data;
			else
				return;
		}
    /* calculate color */
    var charSum = 0;
    for (var i=0; i<msg.from.length; i++)
      charSum += msg.from.charCodeAt(i);
    
    putMsgHTML(msg.body,mtime,msg.from,colors[charSum%(colors.length)]);
  }

	/* disabled: it's annoying */
	//  if (srcW.focusWindows) frames.groupchatBottom.document.forms[0].msgbox.focus();
}

function displayTimestamp() {
  var tstyle;
  if (is.ie) {
    tstyle = cFrame.styleSheets('timestampstyle');
    tstyle.disabled = opener.top.timestamps;
  } else {
    tstyle = cFrame.getElementById("timestampstyle");
    tstyle.sheet.disabled = opener.top.timestamps;
  }
}

function updateMe() {

 	frames.groupchatTop.document.forms[0].subject.disabled = (roster.me.role == 'none');
 	frames.groupchatBottom.document.forms[0].submit.disabled = (roster.me.role == 'none');

	if (roster.me.affiliation == 'owner')
		frames.groupchatBottom.document.getElementById('config_chan_button').style.display = '';
	else
		frames.groupchatBottom.document.getElementById('config_chan_button').style.display = 'none';

	if (roster.me.role == 'none') {// seems we left
		cFrame.body.innerHTML += "<span style='color:red';>"+loc("Disconnected.")+"</span><br>";
		frames.groupchatChat.groupchatIChat.scrollTo(0,cFrame.body.scrollHeight);
	}

	if (frames.groupchatRoster.updateMe)
		frames.groupchatRoster.updateMe();
}

function changeUserStat(jid,stat,val,confirm) {
  var user = roster.getUserByJID(jid);
  var url = "?sid="+srcW.sid+"&to="+msgEscape(group)+"&nick="+user.name+"&"+stat+"="+val;
  var reason;
  if (confirm && (reason = prompt("Reason","")) != '')
    srcW.fhdLoad("muc-set",url+"&reason="+reason);
  else
    srcW.fhdLoad("muc-set",url);
}

function changeRole(jid,role,confirm) {
  changeUserStat(jid,"role",role,confirm);
}

function changeAffiliation(jid,affil,confirm) {
  changeUserStat(jid,"affiliation",affil,confirm);
}

var configW
function openConfig() {
	if (!configW || configW.closed)
		configW = open("groupchatconfig.html","gccW"+makeWindowName(jid),"width=480,height=380,resizable=yes,scrollbars=yes");
		configW.focus();
	return false;
}

function cleanUp() {
	if (configW && !configW.closed)
		configW.close();
}

function part() {
	cleanUp();

  if (!srcW.fhdLoad)
      return;
	if (typeof(roster.me) != 'undefined' && roster.me.role != 'none' && srcW.sid) // we are off anyway
		srcW.fhdLoad("presence","?sid="+srcW.sid+"&to="+msgEscape(group)+"&type=unavailable");
  if (!user.messages.length && !user.chatmsgs.length) {
    srcW.roster.removeUser(user);
    srcW.roster.print();
  }
}

/* global vars */
var srcW,user,roster,cFrame,jid,nick,pass;

function init() {
  getArgs();
  
  srcW = opener;
 
  jid = passedArgs['jid'];
	group = jid;

	if (typeof(passedArgs['nick']) != 'undefined')
		nick = passedArgs['nick'];
	if(typeof(nick) == 'undefined' || nick == '')
		nick = srcW.roster.nick; // guess a nick

	if (passedArgs['pass'] != 'undefined')
		pass = passedArgs['pass'];
  
  srcW.Debug.log("groupchat room: "+jid+", nick: "+nick + ", pass: "+pass ,2);
  
	srcW.fhdLoad("muc-presence","?sid="+srcW.sid+"&to="+msgEscape(group)+"/"+msgEscape(nick)+"&pass="+msgEscape(pass)+"&show="+srcW.onlstat+"&status="+srcW.onlmsg);
  
  cFrame = frames.groupchatChat.groupchatIChat.document;

  user = srcW.roster.getUserByJID(group);
  if(!user) {
    user = srcW.roster.addUser(new RosterUser(group,'',[loc('Chat Rooms')],group.substring(0,group.indexOf('@'))));
    user.chatW = window.self;
  }
  user.status = 'available';
  srcW.roster.print();
  
  user.roster = new GroupchatRoster(window.self);
  user.roster.nick = nick; // remember my nickname
  roster = user.roster;
  //        user.roster.print();
  
	//  document.title += " - " + group;
  document.title = group+'/'+nick;

  popMsgs();
  displayTimestamp();
}


function keyPressed(e) {
  if (e.keyCode == 27)
    window.close();
}

function updateStyleIE() {
  if (user)
    user.roster.updateStyleIE();
}

onkeydown = keyPressed;
onload = init;
onunload = part;
onresize = updateStyleIE;
    </script>

    <script for="document" event="onkeydown()" language="JScript">
      <!--
      if (window.event.keyCode == 27)
      window.close();
      //-->
    </script>

    <frameset rows="40,*,90" frameborder=2 framespacing=2 border=2 bordercolor=black>
      <frame src="groupchat_top.html" name="groupchatTop" scrolling="no">
      <frameset cols="70%,*">
        <frame src="groupchat_chat.html" name="groupchatChat" scrolling="no">
        <frame src="groupchat_roster.html" name="groupchatRoster" scrolling="no">
      </frameset>
      <frame src="groupchat_bottom.html" name="groupchatBottom" scrolling="no">
    </frameset>

  </head>

  <body>
  </body>
</html>
