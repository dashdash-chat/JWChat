<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title></title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <script src="shared.js" language="JavaScript1.2"></script>
    <script src="switchStyle.js"></script>
    <script language="JavaScript1.2">
      <!--

function submitClicked() {
  var url = "?sid=" + parent.srcW.sid + "&to=" + msgEscape(parent.group);
  var body = document.forms[0].elements["msgbox"].value;
  

  if (body == '') // don't send empty message
    return false;
          
  /* handle commands */
  if (body.match(/^\/say (.+)/)) {
		body = RegExp.$1;
		url += "&body=" + msgEscape(body) + "&type=groupchat";
    parent.srcW.fhdLoad("message",url); // send to client
  } else if (body.match(/^\/nick (.+)/)) {
    var nick = body.replace(/^\/nick (.+)/,"$1");
    url += "/"+msgEscape(nick);
    parent.srcW.fhdLoad("presence",url);
  } else if (body.match(/^\/topic (.+)/)) {
    var topic = body.replace(/^\/topic (.+)/,"$1");
    url += "&type=groupchat&subject="+msgEscape(topic);
    parent.srcW.fhdLoad("message",url);
  } else if (body.match(/^\/ban (\S+)\s*(.*)/)) {
		var nick = RegExp.$1;
		var reason = RegExp.$2;

		var jid = parent.roster.getRealJIDByNick(nick);
		if (jid == null) {
			parent.putMsgHTML(loc("No such nick")+": " + nick, new Date().toLocaleTimeString(), parent.jid);
		} else {

			var param = "?sid="+parent.srcW.sid+"&to="+msgEscape(parent.jid)+"&ns="+escape("http://jabber.org/protocol/muc#admin");
			param += "&set="+msgEscape("<item jid='"+jid+"' affiliation='outcast'><reason>"+reason+"</reason></item>");
			parent.srcW.fhdLoad("iq",param);
		}
  } else if (body.match(/^\/kick (\S+)\s*(.*)/)) {
		var nick = RegExp.$1;
		var reason = RegExp.$2;

		var jid = parent.roster.getRealJIDByNick(nick);
		if (jid == null) {
			parent.putMsgHTML(loc("No such nick")+": " + nick, new Date().toLocaleTimeString(), parent.jid);
		} else {

			var param = "?sid="+parent.srcW.sid+"&to="+msgEscape(parent.jid)+"&ns="+escape("http://jabber.org/protocol/muc#admin");
			param += "&set="+msgEscape("<item jid='"+jid+"' role='none'><reason>"+reason+"</reason></item>");
			parent.srcW.fhdLoad("iq",param);
		}
  } else if (body.match(/^\/invite (\S+)\s*(.*)/)) {
		var jid = RegExp.$1;
		var reason = RegExp.$2;
		parent.srcW.fhdLoad("muc-invite","?sid="+parent.srcW.sid+"&to="+msgEscape(parent.jid)+"&invitee="+msgEscape(jid)+"&reason="+reason);
  } else if (body.match(/^\/join (\S+)\s*(.*)/)) {
		var room = RegExp.$1;
		var pass = RegExp.$2;
		parent.srcW.openGroupchat(room,parent.nick,pass);
  } else if (body.match(/^\/msg (\S+)\s*(.*)/)) {
		var nick = RegExp.$1;
		var body = RegExp.$2;

		var jid = parent.roster.getFullJIDByNick(nick);
		if (jid == null)
			parent.putMsgHTML(loc("No such nick")+": " + nick, new Date().toLocaleTimeString(), parent.jid);
		else
			parent.srcW.fhdLoad("message","?sid="+parent.srcW.sid+"&to="+msgEscape(jid)+"&body="+msgEscape(body));
  } else if (body.match(/^\/part\s*(.*)/)) {
		var msg = RegExp.$1;
		parent.srcW.fhdLoad("presence","?sid="+parent.srcW.sid+"&to="+msgEscape(parent.jid)+"&type=unavailable&status="+msg);
  } else if (body.match(/^\/whois (\S+)/)) {
		var nick = RegExp.$1;
		var jid = parent.roster.getFullJIDByNick(nick);
		if (jid == null)
			parent.putMsgHTML(loc("No such nick")+": " + nick, new Date().toLocaleTimeString(), parent.jid);
		else
			parent.srcW.openUserInfo(jid);
  } else if (body.match(/^\/help/)) {
		open("http://www.jabber.org/jeps/jep-0045.html#impl-client-irc");
  } else {
    url += "&body=" + msgEscape(body) + "&type=groupchat";
    parent.srcW.fhdLoad("message",url); // send to client
  }			

  // add message to our message history
  parent.srcW.addtoHistory(body);
  document.forms["chatform"].msgbox.value=''; // empty box
  document.forms["chatform"].msgbox.focus(); // set focus back on input field
  
  return false;
}

var rw;
function openRegisterRoom() {
	if (!rw || rw.closed)
		rw = open("groupchat_register.html","rw"+makeWindowName(parent.jid),"width=300,height=400,resizable=yes");
	rw.focus();

	return false;
}

var iw;
function openInvite() {
	if (!iw || iw.closed)
		iw = open("groupchat_invite_dialog.html","iw"+makeWindowName(parent.group),"width=300,height=200");
	iw.focus();
	return false;
}

function cleanUp() {
	if (iw && !iw.closed)
		iw.close();
	if (rw && !rw.closed)
		rw.close();
}

function msgboxKeyPressed(el,e) {
	var keycode;
	if (window.event) { e  = window.event; keycode = window.event.keyCode; }
	else if (e) keycode = e.which;
	else return true;
	
	switch (keycode) {
	case 13:
		if (!e.shiftKey && !e.ctrlKey)
			return submitClicked();
		break;
	}
	return true;
}

function msgboxKeyDown(el,e) {
	var keycode;
	if (window.event) { e  = window.event; keycode = window.event.keyCode; }
	else if (e) keycode = e.which;
	else return true;

	switch (keycode) {
	case 38:				// shift+up
		if (e.ctrlKey) {
			el.value = parent.srcW.getHistory('up', el.value);
			el.focus(); el.select();
		}
		break;
	case 40:				// shift+down 
		if (e.ctrlKey) {
			el.value = parent.srcW.getHistory('down', el.value);
			el.focus(); el.select();
		}
		break;
	case 76:
		if (e.ctrlKey) {   // ctrl+l
			parent.cFrame.body.innerHTML = '';
			return false;
		}
		break;
	case 27:
		window.close();
		break;
	}
	return true;
}

onunload = cleanUp
      //-->
    </script>
  </head>
  <body style="margin:8px;">
    <form name="chatform">
      <table width="100%" height="100%" border=0 cellpadding=0 cellspacing=0>
          <tr height="100%">
            <td width="100%"><textarea id="msgbox" wrap="virtual" style="width:100%;height:100%;" tabindex=1 onKeyPress="return msgboxKeyPressed(this,event);" onKeyDown="return msgboxKeyDown(this,event);"></textarea></td></tr>
          <tr><td height=5></td></tr>
          <tr>
            <td align="right"><button id="config_chan_button" onClick="return parent.openConfig();" style="display:none;" tabindex=5><l>Config</l></button>&nbsp;<span id="register_room_span" style="display:none;"><button id="register_room_button" onClick="return openRegisterRoom();" tabindex=4><l>Register</l></button>&nbsp;</span><button id="invite_button" onClick="return openInvite();" tabindex=3><l>Invite</l></button>&nbsp;<button id='submit' name='submit' type='submit' onClick="return submitClicked();" tabindex=2><l>Send</l></button></td></tr>
      </table>
    </form>
  </body>
</html>
