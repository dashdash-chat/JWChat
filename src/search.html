<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title><l>JWChat - Search</l></title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <script src="shared.js" language="JavaScript1.2"></script>
    <script src="switchStyle.js"></script>
    <script language="JavaScript1.2">
      <!--

function search() {
	document.getElementById('search_results').style.display = '';
	document.getElementById('search_form').style.display = 'none';

	// send query
	var searchstring = '';
	for (var i=0; i<document.forms['searchfields'].elements.length; i++)
		if (document.forms['searchfields'].elements[i].name != '' && document.forms['searchfields'].elements[i].value != '')
			searchstring += "&"+document.forms['searchfields'].elements[i].name+"="+document.forms['searchfields'].elements[i].value;

	var to = document.forms['service_select'].elements['service'].options[document.forms['service_select'].elements['service'].selectedIndex].value;

	if (searchstring == '')
		srcW.fCBLoad("iq","?sid="+srcW.sid+"&to="+to+"/users&ns=jabber:iq:browse",searchW.handleIQSearch);
	else
		srcW.fCBLoad("iq-set","?sid="+srcW.sid+"&to="+to+"&ns=jabber:iq:search"+searchstring,searchW.handleIQSearch);

	return false;
}

function back() {
	document.getElementById('search_form').style.display = '';
	document.getElementById('search_results').style.display = 'none';

	//	reset form
	document.getElementById('add_button').disabled = true;
	document.getElementById('info_button').disabled = true;
	resultF.selectedRow = null;

	resultF.document.getElementById('results').innerHTML = '';

	return false;
}

function handleIQSearch(jabber) {
	srcW.fdebug(jabber,2);

	// set title
	if (jabber.error == true) {
		document.getElementById('results_header').innerHTML = loc("An error has occured");
		return;
	}
	else
		document.getElementById('results_header').innerHTML = loc("Search results for [_1]", jabber.from);

	var html = "<table width='100%' border=0 cellspacing=0 cellpadding=0>";

	if (jabber.ns == 'jabber:iq:browse') {
		html += "<tr><th>JID</th><th>Name</th></tr>";
		for (var i in jabber.browse.o)
			if (jabber.browse.o[i].tagname == 'user')
				html += "<tr><td>"+jabber.browse.o[i].jid+"</td><td nowrap>"+jabber.browse.o[i].name+"</td></tr>";
	} else {
		html += "<tr><th>jid</th>";
		for (var i=0; i<document.forms['searchfields'].elements.length; i++)
			if (document.forms['searchfields'].elements[i].name != '')
				html += "<th>"+ document.forms['searchfields'].elements[i].name+"</th>";
		html += "</tr>";
 		for (var i in jabber.browse.o) {
 			html += "<tr>";
			html += "<td>"+jabber.browse.o[i].jid+"</td>";
 			for (var j=0; j<document.forms['searchfields'].elements.length; j++) {
				if (document.forms['searchfields'].elements[j].name != '') {
					var val = eval("jabber.browse.o[i]."+document.forms['searchfields'].elements[j].name);
					if (val == '')
						val = '&nbsp;';
					html += "<td nowrap>"+val+"</td>";
				}
			}
 			html += "</tr>";
 		}
	}

	html += "</table>";
	resultF.document.getElementById('results').innerHTML = html;
	resultF.init();
}

function handleIQSearchfields(jabber) {
	srcW.fdebug(jabber,2);

	if (jabber.type != 'result' || typeof(jabber.browse) == 'undefined') {
		alert(loc("An Error Occured\nAborting..."));
		return;
	}

	var html = "<table>";
	if (typeof(jabber.browse['instructions']) != 'undefined')
			html += "<tr><th colspan=2>"+jabber.browse['instructions']+"</th></tr>";

	for (var i in jabber.browse) {
		if (i == 'o' || i == 'instructions')
			continue;
		if (i == 'key')
			html += "<tr><td colspan=2><input type=hidden value=\""+jabber.browse[i]+"\"></td></tr>";
		else
			html += "<tr><td>"+i+"&nbsp;</td><td><input type=\"text\" name=\""+i+"\" value=\""+jabber.browse[i]+"\"></td></tr>";
	}
	html += "</table>";
	html += "<hr noshade size=1><div align=right><button onClick='return search();'>"+loc("Search")+"</button></div>";

	var searchfields = document.getElementById('searchfields');
	searchfields.innerHTML = html;
}

function serviceSelected(selbox) {
	var el = selbox.options[selbox.selectedIndex];

	// clear box
	document.getElementById('searchfields').innerHTML = '';

	if (el.value == '')
		return;

	// query service
	srcW.fCBLoad("iq","?sid="+srcW.sid+"&to="+el.value+"&ns=jabber:iq:search",searchW.handleIQSearchfields);
	return false;
}

var searchW = window;
var srcW;
function init() {
  // determine source window
  if (opener.roster)
    srcW = opener.top;
  else
    srcW = opener.opener.top;

	// detect services
	if (!srcW.disco.items)
		return;
	var service = document.forms['service_select'].elements['service'];
	var optidx = 1;
	for (var  i=0; i<srcW.disco.items.length; i++) {
		var item = srcW.disco.items[i];
		if (!item.info)
			continue;
		for (var j=0; j<item.info.length; j++) {
			var info = item.info[j];
			if (info.tagname == 'feature' && info.far == 'jabber:iq:search')
				service.options[optidx++] = new Option(item.name,item.jid);
		}
	}

	document.getElementById('search_results').style.display = 'none';
	document.getElementById('add_button').disabled = true;
	document.getElementById('info_button').disabled = true;
}

function keyPressed(e) {
  if (e.ctrlKey && e.keyCode == 13)
    submitClicked();
  else if (e.keyCode == 27)
    window.close();
}
onkeydown = keyPressed;
onload = init;
      //-->
    </script>
    <script for="document" event="onkeydown()" language="JScript">
      <!--
      if (window.event.ctrlKey && window.event.keyCode == 13)
      submitClicked();
      if (window.event.keyCode == 27)
      window.close();
      //-->
    </script>
		<style type="text/css">
		th { 
			font-size: 12px; 
			text-align: left;
		}
		.searchfield { padding: 4px; }
		</style>
  </head>

  <body style="margin: 8px;">
		<div id="search_form">
		<form name="service_select">
		<l>Perform search at</l> <select name="service" onChange="return serviceSelected(this);"><option value=''><l>- Choose Directory -</l></option></select>
		</form>
		<form name="searchfields" id="searchfields">
		</form>
		</div>

		<div id="search_results">
		<table height="100%" width="100%">
		<tr><td id="results_header"><l>Querying ...</l></td></tr>
		<tr><td height="100%" width="100%">
		<iframe src="search_iframe.html" id="resultF" name="resultF" scrolling="auto" style="width: 100%; height: 100%"></iframe>
		</td></tr>
		<tr><td align=right>
		<hr noshade size="1">
		<button id="info_button" onClick='return srcW.openUserInfo(resultF.selectedRow.childNodes[0].innerHTML);'><l>User Info<l></button>&nbsp;<button id="add_button" onClick='return srcW.openSubscription(resultF.selectedRow.childNodes[0].innerHTML);'><l>Add Contact<l></button>&nbsp;<button onClick='return back();'><l>Back<l></button>
		</td>
		</tr>
		<table>
		</div>
  </body>
</html>
